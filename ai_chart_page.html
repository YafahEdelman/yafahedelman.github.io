<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch AI Data Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="datasets.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm z-10 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">Epoch AI Data Explorer</h1>
            <p class="text-sm text-gray-500">Visualizing AI Model Trends</p>
        </div>
        <div class="text-xs text-gray-400">
            Powered by <a href="https://epoch.ai/" class="underline hover:text-gray-600">Epoch AI Data</a> & Pollinations.ai
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6 space-y-6">

        <!-- Controls -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div class="mb-4">
                <label for="dataset-select" class="block text-sm font-semibold text-gray-700 mb-2">Select Dataset:</label>
                <select id="dataset-select" class="block w-full rounded-lg border border-gray-300 p-2 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm">
                </select>
            </div>

            <label for="user-prompt" class="block text-sm font-semibold text-gray-700 mb-2">Describe the chart you want to see:</label>
            <div class="flex gap-3">
                <textarea id="user-prompt" rows="2"
                    class="block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm p-3 resize-none"
                    placeholder="e.g., 'Plot Training Compute (FLOP) vs Publication Date', 'Show a bar chart of Parameters for models released in 2023', or 'Compare Training compute cost for different organizations'"></textarea>
                <button id="generate-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 rounded-lg transition-colors flex items-center justify-center shadow-md">
                    <span id="btn-text">Generate Chart</span>
                    <svg id="btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <!-- Quick Suggestions -->
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="text-xs text-gray-500 font-medium py-1">Try:</span>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Compute over Time</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Parameters vs Date</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Models by Organization</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Compute Cost vs Date</button>
            </div>
        </div>

        <!-- Status & Error -->
        <div id="status-area" class="hidden rounded-lg p-4 text-sm font-medium border"></div>

        <!-- Chart Container -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-h-[600px] relative flex flex-col">
            <div id="chart-div" class="flex-1 w-full h-full min-h-[550px]"></div>
            <div class="mt-2 text-right text-[10px] text-gray-400">
                Data source: Epoch AI
            </div>
        </div>

    </main>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const promptInput = document.getElementById('user-prompt');
        const statusArea = document.getElementById('status-area');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const datasetSelect = document.getElementById('dataset-select');

        let currentData = [];
        let currentDatasetName = "AI Models";

        generateBtn.addEventListener('click', () => generateChart(promptInput.value));

        document.querySelectorAll('.quick-prompt').forEach(btn => {
            btn.addEventListener('click', () => {
                promptInput.value = btn.innerText;
                generateChart(btn.innerText);
            });
        });

        function showStatus(message, type = 'info') {
            statusArea.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'border-red-200', 'bg-blue-50', 'text-blue-700', 'border-blue-200', 'bg-green-50', 'text-green-700', 'border-green-200');

            if (type === 'error') {
                statusArea.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
            } else if (type === 'success') {
                statusArea.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            } else {
                statusArea.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
            }
            statusArea.innerText = message;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'Generating...';
                btnSpinner.classList.remove('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'Generate Chart';
                btnSpinner.classList.add('hidden');
            }
        }

        async function generateChart(userRequest) {
            userRequest = userRequest.trim();
            if (!userRequest) {
                showStatus('Please enter a description for the chart.', 'error');
                return;
            }

            setLoading(true);
            showStatus('Analyzing request and generating code...', 'info');

            try {
                // Peek at data structure for prompt
                const sampleData = currentData.slice(0, 3);
                const keys = Object.keys(sampleData[0] || {});

                // Limit keys for the prompt to avoid token limits, but prioritize important ones
                // For now, just send the first 25 keys
                const keysToSend = keys.slice(0, 25);

                const prompt = `
You are a JavaScript Expert specializing in Data Visualization with Plotly.js.
You have access to a variable \`data\` which is an Array of Objects.

Data Sample (First 3 items):
${JSON.stringify(sampleData, null, 2)}

Keys available: ${keysToSend.join(', ')}

User Request: "${userRequest}"

Task:
Write a JavaScript function named \`getChartConfig(data)\` that:
1. Filters and processes the input \`data\` array to fulfill the user request.
2. Returns an object \`{ data: [...], layout: {...} }\` compatible with \`Plotly.newPlot\`.
3. Handles empty or missing values gracefully (e.g. filter out entries where x or y is missing).
4. Creates a professional, clean chart.
5. Returns ONLY valid JavaScript code. NO markdown blocks (like \`\`\`javascript), NO explanations.

Important:
- Dates are strings like "YYYY-MM-DD". Convert to Dates if plotting time.
- Numeric fields might be strings. Parse them.
- Use Log scale if the range is huge.
`;

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai',
                        jsonMode: false
                    })
                });

                if (!response.ok) throw new Error('AI service failed to respond.');

                let text = await response.text();
                console.log("Raw AI Response:\n", text);

                // 1. Try to extract from Markdown block first (most robust)
                const mdMatch = text.match(/```(?:javascript|js)?\s*([\s\S]*?)```/);
                if (mdMatch && mdMatch[1]) {
                    text = mdMatch[1].trim();
                } else {
                    // 2. Fallback: If no markdown, try to find the start of the function
                    const funcStart = text.indexOf('function getChartConfig');
                    if (funcStart !== -1) {
                         text = text.substring(funcStart);
                    } else {
                         // 3. Last resort: If it looks like a returned object, wrap it
                         if (text.includes('return {')) {
                             text = `function getChartConfig(data) { ${text} }`;
                         }
                    }
                }

                console.log("Processed Code:\n", text);

                if (!text.includes('function getChartConfig')) {
                     throw new Error("AI did not return a valid function definition.");
                }

                // Execution
                const runner = new Function('data', text + `
                    try {
                        return getChartConfig(data);
                    } catch(e) {
                        throw new Error("Runtime Error in generated code: " + e.message);
                    }
                `);

                const result = runner(currentData);

                if (!result || !result.data) {
                    throw new Error("Generated code returned invalid Plotly object.");
                }

                if (!result.layout) result.layout = {};
                result.layout.autosize = true;

                Plotly.newPlot('chart-div', result.data, result.layout, { responsive: true, displayModeBar: true });
                showStatus('Chart generated successfully!', 'success');

            } catch (err) {
                console.error(err);
                showStatus('Failed to generate chart: ' + err.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Initial load check
        if (typeof window.EPOCH_DATASETS === 'undefined') {
            showStatus('Error: Data file not loaded. Check "datasets.js".', 'error');
        } else {
            // Populate dropdown
            const datasetNames = Object.keys(window.EPOCH_DATASETS);
            datasetNames.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                datasetSelect.appendChild(opt);
            });

            // Set default
            currentDatasetName = datasetNames[0];
            currentData = window.EPOCH_DATASETS[currentDatasetName];

            console.log(`Loaded ${currentData.length} records for ${currentDatasetName}.`);

            // Listen for changes
            datasetSelect.addEventListener('change', (e) => {
                currentDatasetName = e.target.value;
                currentData = window.EPOCH_DATASETS[currentDatasetName];
                showStatus(`Switched to ${currentDatasetName} (${currentData.length} records).`, 'info');
                // Could auto-generate a new chart here, but the user prompt might need updating
            });

            // Auto-generate a simple one to start
            if (currentDatasetName === "AI Models") {
                generateChart("Plot Training Compute (FLOP) vs Publication Date");
            } else {
                generateChart("Count of items over time");
            }
        }
    </script>
</body>
</html>
