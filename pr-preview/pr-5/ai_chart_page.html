<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch AI Data Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="data.js"></script>
    <script src="datasets.js"></script>
    <script src="datasets_schema.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm z-10 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">Epoch AI Data Explorer</h1>
            <p class="text-sm text-gray-500">Visualizing AI Model Trends</p>
        </div>
        <div class="text-xs text-gray-400">
            Powered by <a href="https://epoch.ai/" class="underline hover:text-gray-600">Epoch AI Data</a> & Pollinations.ai
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6 space-y-6">

        <!-- Controls -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <label for="user-prompt" class="block text-sm font-semibold text-gray-700 mb-2">Describe the chart you want to see:</label>
            <div class="flex gap-3">
                <textarea id="user-prompt" rows="2"
                    class="block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm p-3 resize-none"
                    placeholder="e.g., 'Plot Training Compute (FLOP) vs Publication Date', 'Show a bar chart of Parameters for models released in 2023', or 'Compare Training compute cost for different organizations'"></textarea>
                <button id="generate-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 rounded-lg transition-colors flex items-center justify-center shadow-md">
                    <span id="btn-text">Generate Chart</span>
                    <svg id="btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <!-- Quick Suggestions -->
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="text-xs text-gray-500 font-medium py-1">Try:</span>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Compute over Time</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Parameters vs Date</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Models by Organization</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Compute Cost vs Date</button>
            </div>
        </div>

        <!-- Status & Error -->
        <div id="status-area" class="hidden rounded-lg p-4 text-sm font-medium border"></div>

        <!-- Chart Container -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-h-[600px] relative flex flex-col">
            <div id="chart-div" class="flex-1 w-full h-full min-h-[550px]"></div>
            <div class="mt-2 flex justify-between items-end">
                <div id="active-dataset" class="text-xs text-indigo-600 font-semibold bg-indigo-50 px-2 py-1 rounded"></div>
                <div class="text-[10px] text-gray-400">
                    Data source: Epoch AI
                </div>
            </div>
        </div>

    </main>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const promptInput = document.getElementById('user-prompt');
        const statusArea = document.getElementById('status-area');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const activeDatasetLabel = document.getElementById('active-dataset');

        generateBtn.addEventListener('click', () => generateChart(promptInput.value));

        document.querySelectorAll('.quick-prompt').forEach(btn => {
            btn.addEventListener('click', () => {
                promptInput.value = btn.innerText;
                generateChart(btn.innerText);
            });
        });

        function showStatus(message, type = 'info') {
            statusArea.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'border-red-200', 'bg-blue-50', 'text-blue-700', 'border-blue-200', 'bg-green-50', 'text-green-700', 'border-green-200');

            if (type === 'error') {
                statusArea.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
            } else if (type === 'success') {
                statusArea.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            } else {
                statusArea.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
            }
            statusArea.innerText = message;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'Generating...';
                btnSpinner.classList.remove('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'Generate Chart';
                btnSpinner.classList.add('hidden');
            }
        }

        async function generateChart(userRequest) {
            userRequest = userRequest.trim();
            if (!userRequest) {
                showStatus('Please enter a description for the chart.', 'error');
                return;
            }

            setLoading(true);
            showStatus('Analyzing request and identifying dataset...', 'info');

            try {
                // Prepare schema description
                const schemas = window.DATASET_SCHEMAS || {};
                const datasetNames = Object.keys(schemas);
                if (datasetNames.length === 0) throw new Error("No datasets loaded.");

                // Limit keys to 25 to avoid large payload size
                const schemaDescription = Object.entries(schemas).map(([name, keys]) =>
                    `Dataset: "${name}"\nKeys: ${keys.slice(0, 25).join(', ')}${keys.length > 25 ? '...' : ''}`
                ).join('\n\n');

                const prompt = `
You are a JavaScript Expert specializing in Data Visualization with Plotly.js.

Available Datasets:
${schemaDescription}

User Request: "${userRequest}"

Task:
1. Select the most appropriate dataset from the list above.
2. Write a JavaScript function named \`getChartConfig(data)\` that:
   - Takes an array of objects (\`data\`) as input.
   - Filters and processes the data to fulfill the user request.
   - Returns an object \`{ data: [...], layout: {...} }\` compatible with \`Plotly.newPlot\`.
   - Handles empty or missing values gracefully.
   - Uses Log scale if the range is huge (e.g. Compute, Parameters).
   - Dates are usually strings "YYYY-MM-DD" -> Convert to Date objects.

Response Format (JSON ONLY):
Return valid JSON with no markdown formatting.
{
  "dataset": "Exact name of the selected dataset",
  "code": "The full JavaScript code for the function getChartConfig"
}
`;

                const response = await fetch('https://text.pollinations.ai/openai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer pk_w1ydtl3pBtnBNHuj'
                    },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'gpt-4o-mini',
                        jsonMode: false // Explicitly false as some proxies don't support it
                    })
                });

                if (!response.ok) throw new Error('AI service failed to respond (HTTP ' + response.status + ').');

                let text = await response.text();
                console.log("Raw AI Response:", text);

                let jsonStr = text.trim();

                // Check if the API returned a message object (e.g. { role: "assistant", content: "..." })
                try {
                    const parsedObj = JSON.parse(jsonStr);
                    if (parsedObj && (parsedObj.role || parsedObj.content || parsedObj.reasoning_content)) {
                        if (parsedObj.content) {
                            jsonStr = parsedObj.content;
                        } else if (parsedObj.reasoning_content) {
                            // User requested to allow reasoning content.
                            // If content is missing, we try to extract the JSON from the reasoning content itself.
                            console.warn("AI returned reasoning but no content. Attempting to extract from reasoning...");
                            jsonStr = parsedObj.reasoning_content;
                        }
                    }
                } catch (e) {
                    // Not a JSON message object, treat as raw string
                }

                // Robust JSON extraction:
                // 1. Try to find a markdown code block
                const codeBlockMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    jsonStr = codeBlockMatch[1].trim();
                } else {
                    // 2. Fallback: Find the *last* valid JSON object that looks like our response
                    // We look for a structure that contains "dataset" key.
                    // This is useful if the reasoning contains other JSON objects (like the schema).

                    // Regex to find { ... "dataset": ... }
                    // Note: This is a simple heuristic.
                    const firstBrace = jsonStr.indexOf('{');
                    const lastBrace = jsonStr.lastIndexOf('}');

                    if (firstBrace !== -1 && lastBrace !== -1) {
                        // Extract the whole block
                        const potentialJson = jsonStr.substring(firstBrace, lastBrace + 1);

                        // If it contains "reasoning_content", we might have just re-extracted the outer wrapper?
                        // No, because we already unwrapped it above if it was valid JSON.
                        // But if the unwrapping failed (invalid JSON), we might be here.

                        jsonStr = potentialJson;
                    }
                }

                let aiResponse;
                try {
                    aiResponse = JSON.parse(jsonStr);
                } catch (e) {
                    console.error("JSON Parse Error:", e);
                    throw new Error("Failed to parse AI response as JSON. Raw text logged to console.");
                }

                if (!aiResponse.dataset || !aiResponse.code) {
                    throw new Error("AI response missing dataset name or code.");
                }

                const selectedDatasetName = aiResponse.dataset;
                const generatedCode = aiResponse.code;

                const dataset = window.EPOCH_DATASETS[selectedDatasetName];
                if (!dataset) {
                    throw new Error(`AI selected unknown dataset: "${selectedDatasetName}"`);
                }

                activeDatasetLabel.innerText = `Using: ${selectedDatasetName} (${dataset.length} records)`;
                showStatus('Generating chart...', 'info');

                // Execution
                const runner = new Function('data', generatedCode + `
                    try {
                        return getChartConfig(data);
                    } catch(e) {
                        throw new Error("Runtime Error in generated code: " + e.message);
                    }
                `);

                const result = runner(dataset);

                if (!result || !result.data) {
                    throw new Error("Generated code returned invalid Plotly object.");
                }

                // Apply defaults if missing
                if (!result.layout) result.layout = {};
                result.layout.autosize = true;

                Plotly.newPlot('chart-div', result.data, result.layout, { responsive: true, displayModeBar: true });
                showStatus('Chart generated successfully!', 'success');

            } catch (err) {
                console.error(err);
                let msg = err.message;
                if (msg === 'Failed to fetch') {
                     msg += ' (Network error or adblocker blocked the AI service)';
                }
                showStatus('Failed to generate chart: ' + msg, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Initial load check
        if (typeof window.EPOCH_DATASETS === 'undefined') {
            showStatus('Error: Datasets not loaded. Check "datasets.js".', 'error');
        } else {
            const count = Object.keys(window.EPOCH_DATASETS).length;
            console.log(`Loaded ${count} datasets.`);
            // Auto-generate a simple one to start
            generateChart("Plot Training Compute (FLOP) vs Publication Date for Notable AI Models");
        }
    </script>
</body>
</html>
