<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title V Air Quality Permits Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
                <h1 class="text-xl font-bold text-gray-800">Title V Permits Search</h1>
            </div>
            <div class="text-sm text-gray-500 hidden sm:block">
                Source: EPA ECHO Data (Sample)
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- Search Controls -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Find Facilities</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Facility Name -->
                <div>
                    <label for="facName" class="block text-sm font-medium text-gray-700 mb-1">Facility Name</label>
                    <input type="text" id="facName" placeholder="e.g. Refinery"
                        class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                </div>

                <!-- State -->
                <div>
                    <label for="facState" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <select id="facState"
                        class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white">
                        <option value="">All States</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <!-- City -->
                <div>
                    <label for="facCity" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                    <input type="text" id="facCity" placeholder="e.g. Houston"
                        class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row gap-4 items-center justify-between">
                <div class="text-sm text-gray-500">
                    <span id="resultCount">0</span> facilities found
                </div>
                <div class="flex gap-3 w-full sm:w-auto">
                    <button id="searchBtn" class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors shadow-sm">
                        Search Local
                    </button>
                    <button id="externalSearchBtn" class="flex-1 sm:flex-none bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-6 rounded-lg transition-colors shadow-sm flex items-center justify-center gap-2">
                        Search EPA.gov
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Facility Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">State</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Registry ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Codes</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Details</span></th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="bg-white divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            <!-- Empty State -->
            <div id="emptyState" class="hidden py-12 flex flex-col items-center justify-center text-center">
                <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="text-lg font-medium text-gray-900">No facilities found</h3>
                <p class="text-gray-500 max-w-sm mt-1">Try adjusting your search terms or use the "Search EPA.gov" button for the full database.</p>
            </div>
        </div>
    </main>

    <!-- Data Source -->
    <script src="title_v_data.js"></script>

    <script>
        // State
        const state = {
            data: window.TITLE_V_DATA || [],
            filters: {
                name: '',
                state: '',
                city: ''
            }
        };

        // DOM Elements
        const els = {
            facName: document.getElementById('facName'),
            facState: document.getElementById('facState'),
            facCity: document.getElementById('facCity'),
            searchBtn: document.getElementById('searchBtn'),
            externalSearchBtn: document.getElementById('externalSearchBtn'),
            resultsBody: document.getElementById('resultsBody'),
            resultCount: document.getElementById('resultCount'),
            emptyState: document.getElementById('emptyState')
        };

        // Initialize
        function init() {
            populateStateDropdown();
            renderTable(state.data);
            setupListeners();
        }

        // Populate State Dropdown
        function populateStateDropdown() {
            const states = [...new Set(state.data.map(d => d.fac_state))].sort();
            states.forEach(st => {
                const option = document.createElement('option');
                option.value = st;
                option.textContent = st;
                els.facState.appendChild(option);
            });
        }

        // Filter Logic
        function filterData() {
            const nameQuery = els.facName.value.toLowerCase();
            const cityQuery = els.facCity.value.toLowerCase();
            const stateQuery = els.facState.value;

            return state.data.filter(item => {
                const matchName = item.fac_name.toLowerCase().includes(nameQuery);
                const matchCity = (item.fac_city || '').toLowerCase().includes(cityQuery);
                const matchState = stateQuery ? item.fac_state === stateQuery : true;
                return matchName && matchCity && matchState;
            });
        }

        // Render Table
        function renderTable(data) {
            els.resultsBody.innerHTML = '';
            els.resultCount.textContent = data.length;

            if (data.length === 0) {
                els.emptyState.classList.remove('hidden');
                return;
            } else {
                els.emptyState.classList.add('hidden');
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${item.fac_name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${item.fac_city}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${item.fac_state}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell font-mono">
                        ${item.registry_id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell text-xs">
                        NAICS: ${item.naics_codes || 'N/A'}<br>
                        SIC: ${item.sic_codes || 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="https://echo.epa.gov/detailed-facility-report?fid=${item.registry_id}" target="_blank" class="text-indigo-600 hover:text-indigo-900 hover:underline">View on ECHO &rarr;</a>
                    </td>
                `;
                els.resultsBody.appendChild(row);
            });
        }

        // Event Listeners
        function setupListeners() {
            // Local Search
            const handleSearch = () => {
                const filtered = filterData();
                renderTable(filtered);
            };

            els.searchBtn.addEventListener('click', handleSearch);
            els.facName.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
                else handleSearch(); // Real-time
            });
            els.facCity.addEventListener('keyup', (e) => {
                 if (e.key === 'Enter') handleSearch();
                 else handleSearch();
            });
            els.facState.addEventListener('change', handleSearch);

            // External Search Logic
            els.externalSearchBtn.addEventListener('click', () => {
                // Construct ECHO URL
                // Base: https://echo.epa.gov/facilities/facility-search/results
                // Params: mediaSelected=caa (Clean Air Act)
                // p_nmaj=Y (Major Source - typically Title V)
                // p_fn (Facility Name)
                // p_ct (City)
                // p_st (State)

                let url = 'https://echo.epa.gov/facilities/facility-search/results?mediaSelected=caa&p_nmaj=Y';

                const name = els.facName.value.trim();
                const city = els.facCity.value.trim();
                const state = els.facState.value;

                if (name) url += `&p_fn=${encodeURIComponent(name)}`;
                if (city) url += `&p_ct=${encodeURIComponent(city)}`;
                if (state) url += `&p_st=${state}`;

                window.open(url, '_blank');
            });
        }

        // Run
        init();

    </script>
</body>
</html>
