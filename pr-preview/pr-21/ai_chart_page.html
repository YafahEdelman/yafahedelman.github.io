<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch AI Data Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Use datasets.js instead of data.js -->
    <script src="datasets.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm z-10 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">Epoch AI Data Explorer</h1>
            <p class="text-sm text-gray-500">Visualizing AI Model Trends</p>
        </div>
        <div class="text-xs text-gray-400">
            Powered by <a href="https://epoch.ai/" class="underline hover:text-gray-600">Epoch AI Data</a> & Pollinations.ai
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6 space-y-6">

        <!-- Controls -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <label for="user-prompt" class="block text-sm font-semibold text-gray-700 mb-2">Describe the chart you want to see:</label>
            <div class="flex gap-3">
                <textarea id="user-prompt" rows="2"
                    class="block w-full rounded-lg border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm p-3 resize-none"
                    placeholder="e.g., 'Plot Training Compute (FLOP) vs Publication Date', 'Show a bar chart of Parameters for models released in 2023', or 'Compare Training compute cost for different organizations'"></textarea>
                <button id="generate-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 rounded-lg transition-colors flex items-center justify-center shadow-md">
                    <span id="btn-text">Generate Chart</span>
                    <svg id="btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <!-- Quick Suggestions -->
            <div class="mt-4 flex flex-wrap gap-2">
                <span class="text-xs text-gray-500 font-medium py-1">Try:</span>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Compute over Time</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Parameters vs Date</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Benchmarks: ECI Score vs Release Date</button>
                <button class="quick-prompt text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors">Chip Sales Over Time</button>
            </div>
            <div class="mt-2 text-xs text-gray-400">
                Available Datasets: <span id="dataset-list" class="font-mono">Loading...</span>
            </div>
        </div>

        <!-- Status & Error -->
        <div id="status-area" class="hidden rounded-lg p-4 text-sm font-medium border"></div>

        <!-- Chart Container -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 min-h-[600px] relative flex flex-col">
            <div id="chart-div" class="flex-1 w-full h-full min-h-[550px]"></div>
            <div class="mt-2 text-right text-[10px] text-gray-400">
                Data source: Epoch AI
            </div>
        </div>

    </main>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const promptInput = document.getElementById('user-prompt');
        const statusArea = document.getElementById('status-area');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const datasetListEl = document.getElementById('dataset-list');

        generateBtn.addEventListener('click', () => generateChart(promptInput.value));

        document.querySelectorAll('.quick-prompt').forEach(btn => {
            btn.addEventListener('click', () => {
                promptInput.value = btn.innerText;
                generateChart(btn.innerText);
            });
        });

        // Initialize Dataset List Display
        if (window.EPOCH_DATASETS) {
            const names = Object.keys(window.EPOCH_DATASETS);
            datasetListEl.textContent = names.join(', ');
        } else {
            datasetListEl.textContent = "Error loading datasets.";
        }

        function showStatus(message, type = 'info') {
            statusArea.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'border-red-200', 'bg-blue-50', 'text-blue-700', 'border-blue-200', 'bg-green-50', 'text-green-700', 'border-green-200');

            if (type === 'error') {
                statusArea.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
            } else if (type === 'success') {
                statusArea.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            } else {
                statusArea.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
            }
            statusArea.innerText = message;
        }

        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'Generating...';
                btnSpinner.classList.remove('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.innerText = 'Generate Chart';
                btnSpinner.classList.add('hidden');
            }
        }

        async function generateChart(userRequest) {
            userRequest = userRequest.trim();
            if (!userRequest) {
                showStatus('Please enter a description for the chart.', 'error');
                return;
            }

            setLoading(true);
            showStatus('Selecting dataset and generating code...', 'info');

            try {
                // Prepare context about available datasets
                const datasetNames = Object.keys(window.EPOCH_DATASETS);
                const schemas = window.DATASET_SCHEMAS || {};

                // Construct a summary of datasets for the AI to choose from
                // Limiting keys to first 25 to avoid token limits if many cols
                let schemaSummary = "";
                for (const [name, keys] of Object.entries(schemas)) {
                    schemaSummary += `- ${name}: ${keys.slice(0, 25).join(', ')}${keys.length > 25 ? '...' : ''}\n`;
                }

                // Step 1: Ask AI to choose dataset and write code
                const prompt = `
You are a JavaScript Expert specializing in Data Visualization with Plotly.js.
You have access to a global object \`window.EPOCH_DATASETS\` containing multiple datasets.

Available Datasets and their Schema (Keys):
${schemaSummary}

User Request: "${userRequest}"

Task:
1. Identify the most appropriate dataset from the list above.
2. Write a JavaScript function named \`getChartConfig()\` that:
    - Accesses the chosen dataset via \`window.EPOCH_DATASETS['Dataset Name']\`.
    - Filters and processes the data to fulfill the user request.
    - Returns an object \`{ data: [...], layout: {...} }\` compatible with \`Plotly.newPlot\`.
    - Handles empty or missing values gracefully.
    - Creates a professional, clean chart.
    - Returns ONLY valid JavaScript code. NO markdown blocks (like \`\`\`javascript), NO explanations.

Important:
- Dates are strings like "YYYY-MM-DD". Convert to Dates if plotting time.
- Numeric fields might be string representations or null. Filter/Convert them.
- Use Log scale if range is huge (e.g. FLOP).
- The function MUST be named \`getChartConfig\` and take NO arguments.
- Do NOT assume \`data\` or \`RAW_DATA\` variables exist as arguments.
`;

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai',
                        jsonMode: false
                    })
                });

                if (!response.ok) throw new Error('AI service failed to respond.');

                let text = await response.text();

                // Sanitization
                text = text.replace(/```javascript/g, '').replace(/```/g, '').trim();

                console.log("Generated Code:\n", text);

                if (!text.includes('function getChartConfig')) {
                     if (text.includes('return {')) {
                         text = `function getChartConfig() { ${text} }`;
                     } else {
                         throw new Error("AI did not return a valid function.");
                     }
                }

                // Execution
                const runner = new Function(text + `
                    try {
                        if (typeof getChartConfig !== 'function') {
                             throw new Error("getChartConfig function is not defined.");
                        }
                        // Check if function expects arguments, which implies a misunderstanding by AI
                        if (getChartConfig.length > 0) {
                            console.warn("AI generated function expects arguments, but none will be passed. Attempting to run anyway.");
                        }
                        return getChartConfig();
                    } catch(e) {
                        throw new Error("Runtime Error in generated code: " + e.message);
                    }
                `);

                const result = runner();

                if (!result || !result.data) {
                    throw new Error("Generated code returned invalid Plotly object.");
                }

                // Apply defaults if missing
                if (!result.layout) result.layout = {};
                result.layout.autosize = true;

                Plotly.newPlot('chart-div', result.data, result.layout, { responsive: true, displayModeBar: true });
                showStatus('Chart generated successfully!', 'success');

            } catch (err) {
                console.error(err);
                showStatus('Failed to generate chart: ' + err.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Initial check
        if (!window.EPOCH_DATASETS) {
            showStatus('Error: Data file not loaded. Check "datasets.js".', 'error');
        } else {
            console.log(`Loaded datasets: ${Object.keys(window.EPOCH_DATASETS).join(', ')}`);
            // Auto-generate a simple one to start
            generateChart("Plot Training Compute (FLOP) vs Publication Date");
        }
    </script>
</body>
</html>
